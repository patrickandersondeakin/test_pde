name: Grant Write Access for Passed Students

on:
  push:
    paths:
      - "quiz-results/*.json"

jobs:
  grant_access:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Process latest quiz submission
        run: |
          # Get latest JSON file
          FILE=$(ls quiz-results | sort | tail -n 1)
          echo "Processing $FILE"

          # Read JSON directly
          JSON=$(cat "quiz-results/$FILE")

          # Use jq to extract values
          USERNAME=$(echo "$JSON" | jq -r '.github_username')
          STUDENTID=$(echo "$JSON" | jq -r '.studentID')

          echo "Username: $USERNAME"
          echo "Student ID: $STUDENTID"

          # Basic whitelist (spam protection)
          if [[ "$STUDENTID" != s* ]]; then
            echo "Student ID invalid, aborting"
            exit 1
          fi

          # GitHub username validation
          if ! [[ "$USERNAME" =~ ^[a-zA-Z0-9-]+$ ]]; then
            echo "Invalid GitHub username, aborting"
            exit 1
          fi

          # Add collaborator via GitHub API
          curl -X PUT \
            -H "Authorization: token ${{ secrets.PDE_ADMIN_PAT }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/patrickandersondeakin/test_pde/collaborators/$USERNAME \
            -d '{"permission": "push"}'

